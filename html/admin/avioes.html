<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />
    <link rel="stylesheet" href="css/style.css" />
</head>

<body>
    <nav id="sidebar">
        <div class="d-flex flex-column justify-content-around align-items-center">
            <div class="sidebar-header">
                <img src="../images/logo.svg" width="200px" />
            </div>

            <ul class="list-unstyled components">
                <h5 class="pl-3" id="nome_user"></h5>
                <li class="pl-5 py-3">
                    <a href="index.html">Home</a>
                </li>
                <li class="active pl-5 py-3">
                    <a href="avioes.html">Aviões</a>
                </li>
                <li class="pl-5 py-3">
                    <a href="usuarios.html">Usuários</a>
                </li>
                <li class="pl-5 py-3">
                    <a href="marcas.html">Marcas</a>
                </li>
            </ul>
            <button id="logout" class="px-3 py-2">Sair</button>
        </div>
    </nav>

    <div class="container">
        <h1>Tabela e Cadastro de Aviões</h1>

        <h2>Tabela de Aviões</h2>
        <div class="row">
            <div class="col-12">
                <table id="table" class="table">
                    <thead>
                        <tr>
                            <th scope="col">Modelo</th>
                            <th scope="col">Marca</th>
                            <th scope="col">Série</th>
                            <th scope="col">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable"></tbody>
                </table>
            </div>
        </div>
        <h2>Cadastro de Aviões</h2>
        <form class="d-flex flex-column justify-content-between align-items-center p-5">
            <div class="row fields">
                <div class="col-md-6 col-12">
                    <label for="model">Modelo</label>
                    <input class="col-md-12" type="text" id="model" />
                </div>
                <div class="col-md-6 col-12">
                    <label for="series">Série</label><br />
                    <input class="col-md-12" type="text" id="series" />
                </div>
            </div>
            <div class="row fields">
                <div class="col-md-6 col-12">
                    <label for="company">Marca</label>
                    <select class="col-md-12" id="company" class="col-md-6">
                        <option value="0" disabled selected>Marcas...</option>
                    </select>
                </div>
                <div class="col-md-6 col-12">
                    <label for="engine">Motorização</label><br />
                    <input class="col-md-12" type="text" id="engine" />
                </div>
            </div>
            <div class="row fields">
                <div class="col-md-6 col-12">
                    <label for="max_takeoff_weight">Peso máximo de decolagem</label>
                    <input class="col-md-12" type="text" id="max_takeoff_weight" />
                </div>
                <div class="col-md-6 col-12">
                    <label for="first_year_production">Ano de primeira produção</label><br />
                    <input class="col-md-12" type="text" id="first_year_production" />
                </div>
            </div>
            <div class="row fields">
                <div class="col-md-6 col-12">
                    <label for="tbo">TBO (horas totais motor)</label>
                    <input class="col-md-12" type="text" id="tbo" />
                </div>
                <div class="col-md-6 col-12">
                    <label for="max_capacity">Nº máximo de ocupantes</label><br />
                    <input class="col-md-12" type="text" id="max_capacity" />
                </div>
            </div>
            <div class="row fields">
                <div class="col-md-6 col-12">
                    <label for="max_cruise_speed">Velocidade de cruzeiro *</label>
                    <input class="col-md-12" type="text" id="max_cruise_speed" />
                </div>
                <div class="col-md-6 col-12">
                    <label for="max_range">Alcance máximo</label><br />
                    <input class="col-md-12" type="text" id="max_range" />
                </div>
            </div>
            <div class="row fields">
                <div class="col-md-6 col-12">
                    <label for="max_operating_altitude">Altitude máxima de operações</label>
                    <input class="col-md-12" type="text" id="max_operating_altitude" />
                </div>
                <div class="col-md-6 col-12">
                    <label for="wingspan">Envergadura (ponta de uma asa a outra)</label><br />
                    <input class="col-md-12" type="text" id="wingspan" />
                </div>
            </div>
            <div class="row fields">
                <div class="col-md-6 col-12">
                    <label for="length">Comprimento</label>
                    <input class="col-md-12" type="text" id="length" />
                </div>
                <div class="col-md-6 col-12">
                    <label for="max_tail_height">Altura máxima da cauda</label><br />
                    <input class="col-md-12" type="text" id="max_tail_height" />
                </div>
            </div>
            <div class="row fields">
                <div class="col-md-6 col-12">
                    <label for="min_takeoff_distance">Distância para a decolagem</label>
                    <input class="col-md-12" type="text" id="min_takeoff_distance" />
                </div>
                <div class="col-md-3 col-6 d-flex align-items-center justify-content-around">
                    <label for="available">Está disponível</label>
                    <input type="checkbox" id="available" />
                </div>
                <div class="col-md-3 col-6 d-flex align-items-center justify-content-around">
                    <label for="first_seen">Prioridade</label>
                    <input type="number" id="first_seen" />
                </div>
            </div>
            <div class="row fields">
                <div class="col-12">
                    <label for="int_photos">Fotos internas - Carrossel fotos internas: 1080x1080px, min. 5 fotos</label>
                    <div class="drop-zone">
                        <span class="drop-zone__prompt">Drop file here or click to upload</span>
                        <div class="drop-zone__thumbs"></div>
                        <input class="col-md-12 drop-zone__input" type="file" id="int_photos" multiple />
                    </div>
                </div>
            </div>
            <div class="row fields">
                <div class="col-12">
                    <label for="ex_photos">Fotos externas - Carrossel home: 1350x1080px, min. 2 fotos</label><br />
                    <div class="drop-zone">
                        <span class="drop-zone__prompt">Drop file here or click to upload</span>
                        <div class="drop-zone__thumbs"></div>
                        <input class="col-md-12 drop-zone__input" type="file" id="ex_photos" multiple />
                    </div>
                </div>
            </div>
            <div class="row fields">
                <div class="col-md-6 col-12">
                    <label for="mapa_assentos">Foto mapa dos assentos - Mapa de assentos: 960x960px, max. 1
                        foto</label><br />
                    <div class="drop-zone">
                        <span class="drop-zone__prompt">Drop file here or click to upload</span>
                        <div class="drop-zone__thumbs"></div>
                        <input class="col-md-12 drop-zone__input" type="file" id="mapa_assentos" />
                    </div>
                </div>
            </div>
            <div class="row fields">
                <div class="col-md-6 col-12">
                    <label for="description">Descrição</label>
                    <textarea class="col-md-12 textarea" wrap="hard" id="description"></textarea>
                </div>
                <div class="col-md-6 col-12">
                    <label for="description_en">Descrição em inglês</label>
                    <textarea class="col-md-12 textarea" wrap="hard" id="description_en"></textarea>
                </div>
            </div>
            <button id="save" class="btn-cadastro">Salvar avião</button>
        </form>
    </div>
    <div class="overlay">
        <div class="overlay__inner">
            <div class="overlay__content"><span class="spinner"></span></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"
        integrity="sha256-eTyxS0rkjpLEo16uXTS0uVCS4815lc40K2iVpWDvdSY=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="js/paging.js"></script>

</body>

</html>

<style>
    .sidebar-header {
        background-color: #EDEDED;
        width: 100%;
        text-align: center;
    }

    h2 {
        margin-top: 100px;
    }

    table {
        border-radius: 50px 50px 0 0;
        box-shadow: 3px 3px 3px 1px #cccccc;
        border: none;
        background-color: #FFFFFF;
    }

    thead {
        border-radius: 50px 50px 0 0;
        background-color: #A5132F;
        border: none;
        color: #EDEDED;
    }

    td,
    th {
        vertical-align: middle;
    }

    form {
        background-color: #FFFFFF;
        width: 100%;
    }

    .fields {
        width: 90%;
        margin-top: 10px;
    }

    .fields input {
        border-radius: 5px;
        padding: 5px;
        border: 1px solid #bb1c35;
    }

    .textarea {
        height: 200px;
        padding: 5px;
    }

    .drop-zone {
        border: 1px dashed #000;
        min-height: 200px;
        cursor: pointer;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .drop-zone span {
        line-height: 100px;
    }

    .drop-zone__input {
        display: none;
    }

    .drop-zone__thumb {
        width: 190px;
        height: 190px;
        overflow: hidden;
        background-color: #cccccc;
        background-size: cover;
        position: relative;
        border-radius: 5px;
        margin: 5px;
    }

    .drop-zone__thumb::after {
        content: attr(data-label);
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 5px 0;
        color: #ffffff;
        background: rgba(0, 0, 0, 0.75);
        font-size: 14px;
        text-align: center;
    }

    .drop-zone__thumbs {
        display: none;
        width: 100%;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-around;
        text-align: center;
    }

    .drop-zone__close {
        position: absolute;
        top: 0;
        right: 0;
        width: 30px;
        height: 30px;
        color: #ffffff;
        background: #ff0000;
        font-size: 14px;
        text-align: center;
        line-height: 30px !important;
        border-radius: 5px;
    }

    .btn-cadastro {
        background-color: #CE3E5A;
        color: #EDEDED;
        padding: 5px;
        font-size: 1.2rem;
        width: 200px;
        margin-top: 10px;
    }

    .overlay {
        display: none;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        position: fixed;
        background: #222;
        opacity: 0.3;
    }

    .overlay__inner {
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        position: absolute;
    }

    .overlay__content {
        left: 50%;
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
    }

    .spinner {
        width: 75px;
        height: 75px;
        display: inline-block;
        border-width: 2px;
        border-color: rgba(255, 255, 255, 0.05);
        border-top-color: #fff;
        animation: spin 1s infinite linear;
        border-radius: 100%;
        border-style: solid;
    }

    @keyframes spin {
        100% {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    //let url = "http://localhost:3000";
    let url = "http://162.240.67.88:3000";
    let loaded = false;
    let id;
    $("document").ready(function () {
        const user = sessionStorage.getItem("user");
        if (user == undefined) {
            window.location.href = "login.html"
            return false;
        }
        user_data = JSON.parse(user)
        $('#nome_user').text(user_data.name)

        function getCompanies () {
            $(".overlay").css("display", "block");
            $.ajax({
                method: "GET",
                url: url + "/company/list",
                success: function (data) {
                    data.forEach(el => {
                        $("#company").append(`<option value="${el.id}">${el.name}</option>`)
                    });
                },
                complete: function () {
                    $(".overlay").css("display", "none");
                }
            })
        }

        function getAircrafts () {
            $(".overlay").css("display", "block");
            $.ajax({
                method: "GET",
                url: url + "/aircraft/list?company_id=0",
                success: function (data) {
                    $("#dataTable").empty();
                    data.forEach(el => {
                        $("#dataTable").append(`
                        <tr>
                            <td>
                                ${el.model}
                            </td>
                            <td>
                                ${el.company_name}
                            </td>
                            <td>
                                ${el.series}
                            </td>
                            <td>
                                <button data-id="${el.id}" type="button" class="btn btn-success edit">Editar</button>
                                <button data-id="${el.id}" type="button" class="btn btn-danger delete">Excluir</button>
                            </td>
                        </tr>`)
                    });

                    $("#table").paging({
                        limit: 5,
                        rowDisplayStyle: 'block',
                        activePage: 0,
                        rows: []

                    });
                },
                complete: function () {
                    $(".overlay").css("display", "none");
                }
            })

            $(".edit").off()
            $(".delete").off()

            $(document).on('click', '.edit', function (e) {
                e.preventDefault()
                id = $(this).data("id");
                getAircraft();
            });

            $(document).on('click', '.delete', function (e) {
                e.preventDefault()
                id = $(this).data("id");
                removeAircraft();
            });
        }

        function getAircraft () {
            $(".overlay").css("display", "block");
            $.ajax({
                method: "GET",
                url: url + "/aircraft/get?id=" + id,
                success: async function (data) {
                    $("#model").val(data.model)
                    $("#series").val(data.series)
                    $("#company").val(data.company_id)
                    $("#engine").val(data.engine)
                    $("#max_takeoff_weight").val(data.max_takeoff_weight)
                    $("#first_year_production").val(data.first_year_production)
                    $("#tbo").val(data.tbo)
                    $("#max_capacity").val(data.max_capacity)
                    $("#max_cruise_speed").val(data.max_cruise_speed)
                    $("#max_range").val(data.max_range)
                    $("#max_operating_altitude").val(data.max_operating_altitude)
                    $("#wingspan").val(data.wingspan)
                    $("#length").val(data.length)
                    $("#max_tail_height").val(data.max_tail_height)
                    $("#min_takeoff_distance").val(data.min_takeoff_distance)
                    $("#description").val(data.description)
                    $("#description_en").val(data.description_en)
                    $("#available").prop('checked', Boolean(data.available))
                    $("#first_seen").val(data.first_seen)
                    loaded = true;

                    var dt_interno = new DataTransfer();
                    for (i = 0; i < data.inside_files.length; i++) {
                        await fetch(`..${data.photos_path}/interno/${data.inside_files[i]}`)
                            .then(res => res.blob())
                            .then(blob => {
                                dt_interno.items.add(new File([blob], data.inside_files[i]))
                            })
                    }

                    fileInput = document.querySelector("#int_photos")
                    fileInput.files = dt_interno.files
                    updateThumbnail(fileInput.parentNode, fileInput.files)

                    var dt_externo = new DataTransfer();
                    for (i = 0; i < data.outside_files.length; i++) {
                        await fetch(`..${data.photos_path}/externo/${data.outside_files[i]}`)
                            .then(res => res.blob())
                            .then(blob => {
                                dt_externo.items.add(new File([blob], data.outside_files[i]))
                            })
                    }

                    fileInput = document.querySelector("#ex_photos")
                    fileInput.files = dt_externo.files
                    updateThumbnail(fileInput.parentNode, fileInput.files)

                    var dt_mapa_assentos = new DataTransfer();
                    fetch(`..${data.photos_path}/${data.mapa_assentos}`)
                        .then(res => res.blob())
                        .then(blob => {
                            dt_mapa_assentos.items.add(new File([blob], data.mapa_assentos))
                        })
                        .then(() => {
                            fileInput = document.querySelector("#mapa_assentos")
                            fileInput.files = dt_mapa_assentos.files
                            updateThumbnail(fileInput.parentNode, fileInput.files)
                        })
                },
                complete: function () {
                    $(".overlay").css("display", "none");
                }
            })
        }
        function addAircraft () {
            $(".overlay").css("display", "block");
            obj = JSON.stringify({
                model: $("#model").val(),
                series: $("#series").val(),
                company_id: $("#company").val(),
                company_name: $("#company option:selected").text(),
                engine: $("#engine").val(),
                max_takeoff_weight: $("#max_takeoff_weight").val(),
                first_year_production: $("#first_year_production").val(),
                tbo: $("#tbo").val(),
                max_capacity: $("#max_capacity").val(),
                max_cruise_speed: $("#max_cruise_speed").val(),
                max_range: $("#max_range").val(),
                max_operating_altitude: $("#max_operating_altitude").val(),
                wingspan: $("#wingspan").val(),
                length: $("#length").val(),
                max_tail_height: $("#max_tail_height").val(),
                min_takeoff_distance: $("#min_takeoff_distance").val(),
                description: $("#description").val(),
                description_en: $("#description_en").val(),
                available: Boolean($("#available").is(":checked")),
                first_seen: $("#first_seen").val()
            })


            data = new FormData();
            data.append("request", obj)
            Array.from($('#int_photos').prop('files')).forEach(file => {
                data.append("internos", file)
            });
            Array.from($('#ex_photos').prop('files')).forEach(file => {
                data.append("externos", file)
            });

            data.append("mapa_assentos", $('#mapa_assentos').prop('files')[0])

            $.ajax({
                method: "POST",
                url: url + "/aircraft/add",
                data: data,
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    if (data.success) {
                        swal("Tudo Certo!", "Avião cadastrado com suscesso", "success");
                        getAircrafts()
                    }
                    clearFiedls();
                },
                error: function (data) {
                    swal("Erro!", "Tente novamente mais tarde", "error");
                },
                complete: function () {
                    $(".overlay").css("display", "none");
                }
            })
        }

        function editAircraft () {
            $(".overlay").css("display", "block");
            obj = JSON.stringify({
                id: id,
                model: $("#model").val(),
                series: $("#series").val(),
                company_id: $("#company").val(),
                company_name: $("#company option:selected").text(),
                engine: $("#engine").val(),
                max_takeoff_weight: $("#max_takeoff_weight").val(),
                first_year_production: $("#first_year_production").val(),
                tbo: $("#tbo").val(),
                max_capacity: $("#max_capacity").val(),
                max_cruise_speed: $("#max_cruise_speed").val(),
                max_range: $("#max_range").val(),
                max_operating_altitude: $("#max_operating_altitude").val(),
                wingspan: $("#wingspan").val(),
                length: $("#length").val(),
                max_tail_height: $("#max_tail_height").val(),
                min_takeoff_distance: $("#min_takeoff_distance").val(),
                description: $("#description").val(),
                description_en: $("#description_en").val(),
                available: Boolean($("#available").is(":checked")),
                first_seen: $("#first_seen").val()
            })


            data = new FormData();
            data.append("request", obj)
            Array.from($('#int_photos').prop('files')).forEach(file => {
                data.append("internos", file)
            });
            Array.from($('#ex_photos').prop('files')).forEach(file => {
                data.append("externos", file)
            });

            data.append("mapa_assentos", $('#mapa_assentos').prop('files')[0])

            $.ajax({
                method: "POST",
                url: url + "/aircraft/update",
                data: data,
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    if (data.success) {
                        swal("Tudo Certo!", "Avião alterado com suscesso", "success");
                        getAircrafts()
                    }
                    loaded = false;
                    clearFiedls();
                },
                error: function (data) {
                    swal("Erro!", "Tente novamente mais tarde", "error");
                },
                complete: function () {
                    $(".overlay").css("display", "none");
                }
            })
        }

        function removeAircraft () {
            $(".overlay").css("display", "block");
            obj = JSON.stringify({
                id: id
            })
            data = new FormData();
            data.append("request", obj)

            $.ajax({
                method: "POST",
                url: url + "/aircraft/delete/",
                data: data,
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    if (data.success) {
                        swal("Tudo Certo!", "Avião deletado com suscesso", "success");
                        getAircrafts()
                    }
                },
                error: function (data) {
                    swal("Erro!", "Tente novamente mais tarde", "error");
                },
                complete: function () {
                    $(".overlay").css("display", "none");
                }
            })
        }

        function clearFiedls () {
            $("#model").val("")
            $("#series").val("")
            $("#company").val("")
            $("#engine").val("")
            $("#max_takeoff_weight").val("")
            $("#first_year_production").val("")
            $("#tbo").val("")
            $("#max_capacity").val("")
            $("#max_cruise_speed").val("")
            $("#max_range").val("")
            $("#max_operating_altitude").val("")
            $("#wingspan").val("")
            $("#length").val("")
            $("#max_tail_height").val("")
            $("#min_takeoff_distance").val("")
            $("#description").val("")
            $("#description_en").val("")
            $("#available").prop('checked', false)
            $("#first_seen").val(0)
            updateThumbnail(document.getElementById("int_photos"), Array())
            updateThumbnail(document.getElementById("ex_photos"), Array())
            updateThumbnail(document.getElementById("mapa_assentos"), Array())
        }

        $("#save").click(function (e) {
            e.preventDefault()
            if (!loaded) addAircraft()
            else editAircraft()
        });
        getAircrafts();
        getCompanies();

        function updateThumbnail (dropZoneElement, files) {
            // First time - remove the prompt
            if (dropZoneElement.querySelector(".drop-zone__prompt")) {
                dropZoneElement.querySelector(".drop-zone__prompt").style.display = "none";
            }

            thumbnailElements = dropZoneElement.querySelectorAll(".drop-zone__thumb");
            thumbs = dropZoneElement.querySelector(".drop-zone__thumbs")
            thumbs.style.display = "flex"

            // First time - there is no thumbnail element, so lets create it
            if (thumbnailElements.length > 0) {
                while (thumbs.firstElementChild) {
                    thumbs.firstElementChild.remove();
                }
            }

            files.forEach((file, i) => {
                let thumbnailElement = document.createElement("div");
                thumbnailElement.classList.add("drop-zone__thumb");
                thumbnailElement.dataset.label = file.name;

                let closeElement = document.createElement("span");
                closeElement.classList.add("drop-zone__close");
                closeElement.innerHTML = "X";
                closeElement.addEventListener("click", (e) => {
                    e.stopPropagation()
                    dropZoneElement = e.target.parentNode.parentNode.parentNode
                    thumbsElement = e.target.parentNode.parentNode
                    files = Array.from(dropZoneElement.querySelector("input").files)
                    files.splice(0, 1)
                    var dt = new DataTransfer();
                    files.forEach((file) => {
                        dt.items.add(file);
                    });
                    var file_list = dt.files;
                    dropZoneElement.querySelector("input").files = file_list

                    e.target.parentNode.remove()
                    thumbnailElements = thumbsElement.querySelectorAll(".drop-zone__thumb");

                    if (thumbnailElements.length == 0) {
                        thumbsElement.style.display = "none"
                        dropZoneElement.querySelector(".drop-zone__prompt").style.display = "block";
                    }

                });
                thumbnailElement.appendChild(closeElement);

                thumbs.appendChild(thumbnailElement);

                // Show thumbnail for image files
                const reader = new FileReader();

                reader.readAsDataURL(file);
                reader.onload = () => {
                    thumbnailElement.style.backgroundImage = `url('${reader.result}')`;
                };
            });
        }

        document.querySelectorAll(".drop-zone__input").forEach((inputElement) => {
            const dropZoneElement = inputElement.closest(".drop-zone");

            dropZoneElement.addEventListener("click", (e) => {
                inputElement.click();
            });

            inputElement.addEventListener("change", (e) => {
                if (inputElement.files.length) {
                    updateThumbnail(dropZoneElement, inputElement.files);
                }
            });

            dropZoneElement.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZoneElement.classList.add("drop-zone--over");
            });

            ["dragleave", "dragend"].forEach((type) => {
                dropZoneElement.addEventListener(type, (e) => {
                    dropZoneElement.classList.remove("drop-zone--over");
                });
            });

            dropZoneElement.addEventListener("drop", (e) => {
                e.preventDefault();

                if (e.dataTransfer.files.length) {
                    inputElement.files = e.dataTransfer.files;
                    updateThumbnail(dropZoneElement, e.dataTransfer.files);
                }

                dropZoneElement.classList.remove("drop-zone--over");
            })
        })
    
    })
</script>